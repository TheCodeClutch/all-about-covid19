<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css?family=Montserrat&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.2/animate.min.css">

    <link rel="stylesheet" href="./css/help.css">
    <title>COVID'19|HELP</title>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12" id="preloader"></div>
        </div>
    </div>

    <nav class="navbar navbar-expand-lg sticky-top navbar-light bg-light">
        <img src="assets/covid-logo.PNG" alt="covid-logo" style="width: 42px; height:40px;">
        <a class="navbar-brand" href="index.html" style="padding-left:5px;">COVID-19</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item" style="padding-left : 20px; padding-right : 20px">
                    <a class="nav-link" href="index.html">Information</a>
                </li>
                <li class="nav-item" style="padding-left : 20px; padding-right : 20px">
                    <a class="nav-link" href="./statistics.html">Statistics</a>
                </li>
                <li class="nav-item" style="padding-left : 20px; padding-right : 20px">
                    <a style="display: none;" id="login" class="btn btn-outline-dark"
                        href="https://accounts.google.com/o/oauth2/v2/auth?access_type=offline&client_id=494631050345-uov5hrao1lv23e78bpmbn6t5argm5qug.apps.googleusercontent.com&prompt=consent&redirect_uri=https%3A%2F%2Fallaboutcovid-19.herokuapp.com%2Fauth%2Fgoogle&response_type=code&scope=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.email%20https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.profile"
                        role="button" style="text-transform:none">
                        <img width="20px" style="margin-bottom: 2px; margin-right: 2px;" src="./assets/google.webp"
                            alt="Google sign-in">
                        Login with Google
                    </a>
                    <span id="user-pic"></span><span id="user-name" style="padding:10px 8px 8px 8px;"></span>
                </li>
            </ul>

        </div>
    </nav>

    <div class="container-fluid">
        <div class="row" style="text-align:center">
            <!-- HashTags and Quotes -->
            <div class="col-12" style="background-color: #FFFAFA; height:30px;">
                <h6 style="font-size:14px; padding:5px 0px;" id="hashtag"></h6>
            </div>
            <div class="col-12" style="margin-top: 50px;">
                <h2>Help Station</h2>
            </div>
        </div>


        <div class="row" style="margin-top:20px;">
            <div class="col-12 col-lg-2"></div>
            <div class="col-12 col-lg-8">
                <div class="row">
                    <div class="col-6">
                        <h3>Post Request</h3>
                    </div>

                    <div class="col-6" style="text-align: right;">
                        <a href="./showRequest.html"><button id="all-requests" style="min-width : 60%"
                                class="btn btn-primary"><strong>See All Requests</strong></button></a>
                    </div>
                    <div class="col-12">
                        <span style="font-size : 14px">*Login before posting request</span>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-2"></div>
        </div>

        <div class="row" style="margin-top:20px;">
            <div class="col-12 col-lg-2"></div>
            <div class="col-12 col-lg-8">
                <div class="row">
                    <div class="col-12">
                        <input onfocus="fieldReset(event)" type="hidden" name="country" id="countryId" value="IN" />
                    </div>
                    <div class="col-6">
                        <label for="stateId">State<sup>*</sup></label>
                        <select onfocus="fieldReset(event)" name="state" class="states order-alpha" id="stateId">
                            <option value="">Select State</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label for="cityId">City<sup>*</sup></label>
                        <select onfocus="fieldReset(event)" name="city" class="cities order-alpha" id="cityId">
                            <option value="">Select City</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <label for="title">Title<sup>*</sup></label>
                        <input onfocus="fieldReset(event)" type="text" id="title" placeholder="Title">
                    </div>

                    <div class="col-12">
                        <label for="message">Request<sup>*</sup></label>
                        <textarea onfocus="fieldReset(event)" id="message"
                            placeholder="Description (Minimum 100 characters required)"
                            style="min-height:150px;"></textarea>
                    </div>

                    <div class="col-12"
                        style="margin-top:20px; text-align:center; min-width : 100%; margin-bottom: 10px;">
                        <button id="submit-btn" class="btn btn-primary"><strong>Send Request</strong></button>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-2"></div>
        </div>
    </div>

    <!-- Footer -->
    <!-- <footer>
        <div style="padding:10px 0px;">
            &copy; 2020 Copyright:
            <a href="about.html">KnowAboutUs</a>
        </div>
    </footer> -->


    <script src="./js/auth-token.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>

    <script src="//geodata.solutions/includes/statecity.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/promise-polyfill"></script> -->

    <script>
        document.getElementById("preloader").style.display = "block";
        async function loginCheck() {
            if (localStorage.getItem('ABC19_SID') !== null) {
                let resp = await fetch("https://allaboutcovid-19.herokuapp.com/auth/isloggedin", {
                    method: 'GET',
                    headers: {
                        Authorization: localStorage.getItem('ABC19_SID')
                    }
                })
                let res = await resp.json()
                if (res.status === 401) {
                    document.getElementById("login").style.display = "block";
                    localStorage.setItem('ABC19_login', false);
                }
                else {
                    localStorage.setItem('ABC19_login', true);
                    document.getElementById('user-name').innerHTML = res.name;
                    document.getElementById('user-pic').innerHTML = `<img src="${res.profile_pic}" style="height : 40px; width : 40px; border-radius : 50%; margin-right : 15px">`
                }

            } else {
                document.getElementById("login").style.display = "block";
                localStorage.setItem('ABC19_login', false);
            }
        }
        async function updateLoginWithUrl(url) {
            let name = await url.searchParams.get("name");
            let email = await url.searchParams.get("email");
            let sessionID = await url.searchParams.get("sessionID");
            let image = await url.searchParams.get("image");
            localStorage.setItem('ABC19_SID', sessionID);
            localStorage.setItem('ABC19_login', true);
            document.getElementById('user-name').innerHTML = name;
            document.getElementById('user-pic').innerHTML = `<img src="${image}" style="height : 40px; width : 40px; border-radius : 50%; margin-right : 15px">`
        }

        function updateStorageVar() {
            if (localStorage.getItem('ABC19_SID') !== null) {
                localStorage.setItem('ABC19_login', true);
            } else {
                localStorage.setItem('ABC19_login', false);
            }
        }

        function fieldReset(e) {
            e.target.style.borderColor = 'lightgray'
            document.getElementById('submit-btn').innerHTML = "Send Request";
        }

        function getFormattedTime() {
            let date = new Date();
            let monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            var dateString = date.getDate() + " " + monthNames[date.getMonth()] + " " + date.getFullYear() + ", " + date.getHours() + ":" + ("00" + date.getMinutes()).slice(-2)
            return dateString;
        }

        function validate() {
            let isValid = true;
            if (document.getElementById('stateId').value.length === 0) {
                document.getElementById('stateId').style.borderColor = '#FF073A'
                isValid = false;
            }
            if (document.getElementById('cityId').value.length === 0) {
                document.getElementById('cityId').style.borderColor = '#FF073A'
                isValid = false;
            }
            if (document.getElementById('title').value.length === 0) {
                document.getElementById('title').style.borderColor = '#FF073A'
                isValid = false;
            }
            if (document.getElementById('message').value.length <= 100) {
                document.getElementById('message').style.borderColor = '#FF073A'
                isValid = false;
            }
            if (isValid) {
                return true;
            }
            return false;
        }

        let url_string = window.location.href;
        let url = new URL(url_string);
        if (url.searchParams.get("name") !== null) {
            updateLoginWithUrl(url);
        } else {
            loginCheck();
        }
        window.onload = function () {
            document.getElementById("preloader").style.display = "none";
            var quotes = ["#StaySafe", "#StayAtHome", "#SocialDistancing", "#IndiaFightsCorona", "#SafeHands", "#TogetherAtHome", "#QuarantineAndChill",
                "#FlattenTheCurve", "#Lockdown", "#WorkingFromHome", "#ViewFromMyWindow", "#MyPandemicSurvivalPlan", "#IndiaFightsBack", "#WithMe",
                "#EverydayIsASunday", "#CoronaWarriors", "#MyGovFactCheck"];

            for (let i = 0; i < quotes.length; i++) {
                console.log(quotes[i]);
                setTimeout(function () {
                    document.getElementById("hashtag").innerHTML = quotes[i];
                }, i * 2000);
            }
            updateStorageVar();
            document.getElementById('submit-btn').addEventListener('click', () => {
                if (localStorage.getItem('ABC19_login') === 'true') {
                    if (validate()) {
                        document.getElementById('submit-btn').innerHTML = "Sending...";
                        let data = {
                            time_ms: Date.now(),
                            time_formatted: getFormattedTime(),
                            state: document.getElementById('stateId').value,
                            city: document.getElementById('cityId').value,
                            title: document.getElementById('title').value,
                            description: document.getElementById('message').value,
                        }
                        fetch('https://allaboutcovid-19.herokuapp.com/posts/saveposts', {
                            method: 'POST',
                            headers: {
                                'content-type': 'application/json',
                                'Authorization': localStorage.getItem('ABC19_SID')
                            },
                            body: JSON.stringify(data)
                        })
                            .then(res => res.json())
                            .then(data => {
                                console.log()
                                if (data.msg !== undefined) {
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Yayayay',
                                        text: data.msg
                                    })
                                    document.getElementById('submit-btn').innerHTML = "Send Request";
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Oops...',
                                        text: data.err
                                    })
                                    document.getElementById('submit-btn').innerHTML = "Send Request";
                                }

                            })
                    }
                }
                else {
                    Swal.fire({
                        title: 'Login',
                        text: "You need to be logged in before posting",
                        icon: 'info',
                        showClass: {
                            popup: 'animated fadeInDown faster'
                        },
                        body: JSON.stringify(data)
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.msg !== undefined) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Yayayay',
                                    text: data.msg
                                })
                                document.getElementById('submit-btn').innerHTML = "Send Request";
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Oops...',
                                    text: data.err
                                })
                                document.getElementById('submit-btn').innerHTML = "Send Request";
                            }
                        })

                    document.getElementsByClassName('swal2-confirm swal2-styled')[0].innerHTML = `<img width="20px" style="margin-bottom: 2px; margin-right: 2px;" src="./assets/google.webp"
                            alt="Google sign-in">
                        Login with Google`
                    document.getElementsByClassName('swal2-confirm swal2-styled')[0].style.color = '#000000'
                }
            })
        }



    </script>

</body>

</html>