<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
		integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
	<link rel="stylesheet" href="./css/showRequest.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.2/animate.min.css">
	<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
</head>

<body></body>


<div class="container-fluid">
	<div class="row">
		<div class="col-12" id="preloader"></div>
	</div>
</div>

<nav class="navbar navbar-expand-lg sticky-top navbar-light bg-light">
	<a class="navbar-brand" href="#">COVID-19</a>
	<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
		aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
		<span class="navbar-toggler-icon"></span>
	</button>

	<div class="collapse navbar-collapse" id="navbarSupportedContent">
		<ul class="navbar-nav ml-auto">
			<li class="nav-item" style="padding-left : 20px; padding-right : 20px">
				<a class="nav-link" href="index.html">Information</a>
			</li>
			<li class="nav-item" style="padding-left : 20px; padding-right : 20px">
				<a class="nav-link" href="./statistics.html">Statistics</a>
			</li>
			<li class="nav-item" style="padding-left : 20px; padding-right : 20px">
				<a style="display: none;" id="login" class="btn btn-outline-dark"
					href="https://accounts.google.com/o/oauth2/v2/auth?access_type=offline&client_id=494631050345-uov5hrao1lv23e78bpmbn6t5argm5qug.apps.googleusercontent.com&prompt=consent&redirect_uri=https%3A%2F%2Fallaboutcovid-19.herokuapp.com%2Fauth%2Fgoogle&response_type=code&scope=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.email%20https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.profile"
					role="button" style="text-transform:none">
					<img width="20px" style="margin-bottom: 2px; margin-right: 2px;" src="./assets/google.webp"
						alt="Google sign-in">
					Login with Google
				</a>
				<span id="user-pic"></span><span id="user-name"></span>
			</li>
		</ul>

	</div>
</nav>






<!-- Post viewing form section -->
<div class="container-fluid">
	<div class="row" style="text-align:center">
		<div class="col-12" style="margin-top: 50px;">
			<h2>Help Station</h2>
		</div>
	</div>


	<div class="row" style="margin-top:30px;">
		<div class="col-12 col-lg-2"></div>
		<div class="col-12 col-lg-8">
			<div class="row">
				<div class="col-6">
					<h3>View Requests</h3>
				</div>

				<div class="col-6" style="text-align: right;">
					<button id="all-requests" class="btn btn-primary"><strong>Post Request</strong></button>
				</div>
				<div class="col-12">
					<span style="font-size : 14px">*Login before commenting on any post</span>
				</div>
			</div>
		</div>
		<div class="col-12 col-lg-2"></div>
	</div>

	<div class="row" style="margin-top:30px;">
		<div class="col-12 col-lg-2"></div>
		<div class="col-12 col-lg-8">
			<div class="row">
				<div class="col-12">
					<input onfocus="fieldReset(event)" type="hidden" name="country" id="countryId" value="IN" />
				</div>
				<div class="col-6">
					<label for="stateId">State<sup>*</sup></label>
					<select onfocus="fieldReset(event)" name="state" class="states order-alpha" id="stateId">
						<option value="">Select State</option>
					</select>
				</div>
				<div class="col-6">
					<label for="cityId">City<sup>*</sup></label>
					<select onfocus="fieldReset(event)" name="city" class="cities order-alpha" id="cityId">
						<option value="">Select City</option>
					</select>
				</div>
				<div class="col-12" style="margin-top:30px; text-align:center; min-width : 100%">
					<button id="submit-btn" class="btn btn-primary"><strong>View all requests</strong></button>
				</div>
			</div>
		</div>
		<div class="col-12 col-lg-2"></div>
	</div>
</div>

<!-- Place for showing posts -->
<div class="container-fluid" style="margin-top : 100px">
	<div class="row">
		<div class="col-12 col-lg-2"></div>
		<div class="col-12 col-lg-8" id="posts">
			<h2 style="text-align: center;" id="post-heading"></h2>
			<div id="posts-container"></div>
		</div>
		<div class="col-12 col-lg-2"></div>
	</div>
</div>





<script src="./js/auth-token.js"></script>
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>

<script src="//geodata.solutions/includes/statecity.js"></script>
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
	integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
	integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

<script>
	AOS.init();
</script>

<script>


	// document.getElementById('add-comment').addEventListener('click', (req, res) => {
	// 	// Popup for entering comment

	// 	// On enetring comment validate for min of 50 char

	// 	// if (validate == true)
	// 			// send a request on success or failure show a time based popup
	// 			// then refresh the page with updated comments
	// 	// else 
	// 			// make box red field reset and stuff
	// })




	document.getElementById("preloader").style.display = "block";



	async function loginCheck() {
		if (localStorage.getItem('ABC19_SID') !== null) {
			let resp = await fetch("https://allaboutcovid-19.herokuapp.com/auth/isloggedin", {
				method: 'GET',
				headers: {
					Authorization: localStorage.getItem('ABC19_SID')
				}
			})
			let res = await resp.json()
			if (res.status === 401) {
				document.getElementById("login").style.display = "block";
				localStorage.setItem('ABC19_login', false);
			}
			else {
				localStorage.setItem('ABC19_login', true);
				document.getElementById('user-name').innerHTML = res.name;
				document.getElementById('user-pic').innerHTML = `<img src="${res.profile_pic}" style="height : 40px; width : 40px; border-radius : 50%; margin-right : 15px">`
			}

		} else {
			document.getElementById("login").style.display = "block";
			localStorage.setItem('ABC19_login', false);
		}
	}
	async function updateLoginWithUrl(url) {
		let name = await url.searchParams.get("name");
		let email = await url.searchParams.get("email");
		let sessionID = await url.searchParams.get("sessionID");
		let image = await url.searchParams.get("image");
		localStorage.setItem('ABC19_SID', sessionID);
		localStorage.setItem('ABC19_login', true);
		document.getElementById('user-name').innerHTML = name;
		document.getElementById('user-pic').innerHTML = `<img src="${image}" style="height : 40px; width : 40px; border-radius : 50%; margin-right : 15px">`
	}

	function updateStorageVar() {
		if (localStorage.getItem('ABC19_SID') !== null) {
			localStorage.setItem('ABC19_login', true);
		} else {
			localStorage.setItem('ABC19_login', false);
		}
	}

	function fieldReset(e) {
		e.target.style.borderColor = 'lightgray'
		document.getElementById('submit-btn').innerHTML = "Send Request";
	}

	function getFormattedTime() {
		let date = new Date();
		let monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
		var dateString = date.getDate() + " " + monthNames[date.getMonth()] + " " + date.getFullYear() + ", " + date.getHours() + ":" + ("00" + date.getMinutes()).slice(-2)
		return dateString;
	}

	function validate() {
		let isValid = true;
		if (document.getElementById('stateId').value.length === 0) {
			document.getElementById('stateId').style.borderColor = '#FF073A'
			isValid = false;
		}
		if (document.getElementById('cityId').value.length === 0) {
			document.getElementById('cityId').style.borderColor = '#FF073A'
			isValid = false;
		}
		if (isValid) {
			return true;
		}
		return false;
	}

	let url_string = window.location.href;
	let url = new URL(url_string);
	if (url.searchParams.get("name") !== null) {
		updateLoginWithUrl(url);
	} else {
		loginCheck();
	}
	window.onload = function () {
		document.getElementById("preloader").style.display = "none";
		updateStorageVar();
		document.getElementById('submit-btn').addEventListener('click', () => {
			if (validate()) {
				document.getElementById('submit-btn').innerHTML = "Requesting...";
				let data = {
					state: document.getElementById('stateId').value,
					city: document.getElementById('cityId').value,
				}
				fetch('https://allaboutcovid-19.herokuapp.com/posts/getposts', {
					method: 'POST',
					headers: {
						'content-type': 'application/json',
					},
					body: JSON.stringify(data)
				})
					.then(res => res.json())
					.then(resp => {
						if (resp.msg !== undefined) {
							let data = resp.msg;
							let content = "";
							for (let i = 0; i < data.length; i = i + 1) {
								content = content + `<div data-aos="zoom-out"  style="margin-top : 20px; margin-bottom : 20px">
													<div class="card" style="width: 100%">
														<div class="card-body">
															<div style="display: inline-block;">
																<img src='${data[i].IMAGE_URL}' style="height: 60px; width : 60px; border-radius: 50%; margin-right : 20px;">
															</div>
															<div style="display: inline-block;transform: translateY(25%);">
																<h5 class="card-title">${data[i].TITLE}</h5>
																<h6 class="card-subtitle mb-2 text-muted">by ${data[i].NAME}</h6>
															</div>
															<div class="time" style="float: right; transform: translateY(50%);">
													<span>${data[i].TIME_FORMATTED}</span>
															</div>
															<div style="margin-top : 20px">
															<p class="card-text">${data[i].DESCRIPTION}</p>
															<a class="card-link" onclick="changeText(event)" data-toggle="collapse" href='#${data[i].POST_ID}' role="button" aria-expanded="false" aria-controls="collapseExample">Show comments</a>
															<a href="" onclick='addComment(event)' data-abc19-post-id='${data[i].POST_ID}' id="add-comment" class="card-link">Add comments</a>
														</div>
														</div>
													</div>
													<div class="collapse" id='${data[i].POST_ID}'>`

								for (let j = 0; j < data[i].COMMENTS.length; j = j + 1) {

									content = content + `														
													<div class="card" style="padding-left : 40px">
															<div class="card-metadata card-body">
																<div class="name-email" style="float: left;">
																	<img src='${data[i].COMMENTS[j].PIC_URL}' style="height: 40px; width : 40px; border-radius: 50%; margin-right : 20px"><span class="name">${data[i].COMMENTS[j].NAME}</span>
																</div>
																<div class="date time" style="float: right; transform: translateY(25%);">
																	${data[i].COMMENTS[j].TIME_FORMATTED}
																</div>
															</div>
															<div class="card-body" style="padding-top : 0; text-align: justify;">
																${data[i].COMMENTS[j].COMMENT_DESC}
															</div>
														</div>`
								}

								content = content + '</div></div>';
							}// final for ending
							document.getElementById('submit-btn').innerHTML = "View all requests"
							document.getElementById('post-heading').innerHTML = "Posts"
							document.getElementById('posts').style.display = 'block';
							document.getElementById('posts-container').innerHTML = content;
						} // if resp !== msg ends
					}) // fetch call response ends

			} // validation ends
		})// click 
	} // window onload ends
			// 								else {
			// 									// popup error normal oops
			// 									Swal.fire({
			// 											icon: 'error',
			// 											title: 'Oops...',
			// 											text: 'There was some error while fetching posts.\n Try again'
			// 									})
			// 								}

			// 						})
			// 				}
			// })
			// }



</script>
<script>


	function changeText(e) {
		console.log(e.target.innerText)
		if (e.target.innerHTML === "Show comments") {
			console.log('Hello')
			e.target.innerHTML = "Hide comments"
			console.log(e.target.innerText)
		}
		if (e.target.innerHTML === "Hide comments") {
			e.target.innerHTML = "Show comments"
		}
		// show comment & hide comment
	}


	function addComment(event) {
		console.log(event.target.getAttribute('data-abc19-post-id'))
		Swal.fire({
			input: 'textarea',
			title: 'Comment box',
			inputPlaceholder: 'Type your comment here...',
			inputAttributes: {
				'aria-label': 'Type your comment here'
			},
			confirmButtonText: 'Post comment', showClass: {
				popup: 'animated fadeInDown faster'
			},
			hideClass: {
				popup: 'animated fadeOutUp faster'
			},
			showCancelButton: false
		})
			.then(res => {
				// ajax call res.value 
				let data = {
					time_ms: Date.now(),
					time_formatted: getFormattedTime(),
					description: res.value,
					post_id: event.target.getAttribute('data-abc19-post-id')
				}
				fetch('https://allaboutcovid-19.herokuapp.com/posts/savecomment', {
					method: 'POST',
					headers: {
						'content-type': 'application/json',
					},
					body: JSON.stringify(data)
				})
					.then(res => {
						if (res.msg !== undefined) {
							Swal.fire({
								icon: 'success',
								title: 'Yayayay',
								text: res.msg
							})
						} else {
							Swal.fire({
								icon: 'error',
								title: 'Oops...',
								text: res.err
							})
						}
					})
			})
	}

</script>
</body>

</html>